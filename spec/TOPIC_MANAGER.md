# 话题管理器——模块介绍
本模块将会是一个顶级模块，写在./topic_manager/文件夹里，旨在帮助主播追踪，选择和管理直播时出现的话题。话题管理器将会随着直播的进行维护一张数据表，增加新出现的话题，编辑跟进已有的话题，并删除过期的话题。通过节省时间的手段在主播回复之前提取出最有价值的话题。注意：本模块只是关于追踪话题，不涉及记忆，也不会留下任何基于文件的永久数据。
## 话题的写入
如果将该话题的处理整个直接放到主管线里作为一种前处理器，势必会增加大量延迟，所以为了避免这一点，话题写入的主要操作将会是由弹幕触发，或是转变成后处理器，而不是随着主播回复触发。影响主播回复的部分将会被尽量精简使其不涉及对语言模型的请求。
### 话题表的设计
包含一系列话题。每个话题包含的信息有：话题id（topic_id, snake case的字符串），重要性（significance），当前状态（topic_progress，用自然语言的描述，表明这个话题现在聊到哪了），话题相关的弹幕（一系列评论的id，根据时间排列，允许根据话题直接取出对应弹幕的其它信息）和用户（也是一系列id），跟进建议（suggestion以第三方顾问的视角对主播的提示，告诉ta如果要选择跟进这个话题可以从哪方面继续发言）。根据后续提到的功能需求可以酌情加入更多的参数。
### 初始化
直播间刚开始时明显是没有话题的，话题管理器需要通过主播的人设主动选一个初始话题出来。初始话题不能太过突兀地突然进入一个具体的主题，一般也需要鼓励包含一些问候，自我介绍的内容……这部分意思有点复杂，相关的prompt你自己理解理解后拟定一下吧。
### 接受弹幕
暂定，接受弹幕的触发方法有两种备选，都做出来

单次触发：每接受到一个弹幕后都会被触发，因为只有一条弹幕，模型请求尽可能精简，立刻判断该弹幕属于哪一条并做出对应的修改。

批量触发：有一个固定的等待时间和一个弹幕的收集数。达到收集数后会立刻进行一次更新，而如果等待时间到了且至少有一个新弹幕，也会触发一次更新。

不论如何，弹幕处理和主播回复永远不该相互阻断，即便这代表着让主播回复时只得到未更新的话题数据。

接收弹幕的主要操作是将弹幕和用户归分类归给话题（重复出现的用户会被重新插入到列表的最后，刷新位置），在目前阶段弹幕并不会触发创建新话题和更改话题状态。
### 回复后处理
对话题的另一部分影响来自于由主播回复触发的后处理。和记忆功能一样，由于回复已经生成完了，这部分后处理会独立进行，不会额外增加返回回复的延迟。
话题管理器会通过call小模型来判断一系列事情：
- 总结，是否有话题被推进，是否有新话题被创建。
- 是否有哪些话题可以追加发言（这样假如下次回复时没有新评论，可以直接提示主模型在这几个话题中选择一个进行发言）。
- 决定当前的几个话题是否被聊了太久。这样可以直接加一个要求主播主动另选新话题的指令到下次的prompt中。
- 也会判断当前谈话的节奏，动态决定下次回复前的等待时间。
由于需要判断的主题有点多，为了保证模型API的响应速度和专注主题，是否可以选择同时异步发送多个单独请求？

另外，根据回复为标志，也会触发已有话题的重要性时间衰减。

## 话题的输出
话题对主播的影响肯定是表现在prompt上。该流程不会包含任何语言模型请求，所以延迟应该会很短。

输入模型的弹幕会先经过话题管理器的处理，其中与已有话题相关的弹幕会被标注。

重要性最高的几个话题（数量可设置）和相关会被直接列出来（但话题关联的弹幕只用选最近的几个（数量可设置），会取回对应的内容）（话题相关用户也只选用最近的几个，会取回对应的昵称）。如果最近弹幕中提到了一个话题，即便它重要性很低也一定会被列出来。

加入额外的prompt让主播对话题进行反应。

（可选开关，默认关）根据最新的输入和选定的话题，由管理器决定出是否需要动用网络搜索来获得最新的资讯。如果需要搜索，又该使用什么关键词或短语进行搜索？需要搜索的情况下动用langchain内置对tavily search的支持库进行搜索并把结果同步到prompt中话题表的位置。这一环会无可避免地加入大量延迟，有什么建议的改进方向吗？

# 其它要求
- 由于这又是个新加入的重要功能，让它和记忆模块一样可以整体通过参数选择是否加入主流程
- 和以往一样，保证合适的抽象程度，尽量减少它对已有代码的影响和侵入性
- 在实际应用过程中如果碰到理应被设置为可设置参数的参数，也把他们加进config来